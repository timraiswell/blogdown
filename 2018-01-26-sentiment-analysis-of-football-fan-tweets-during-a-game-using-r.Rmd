---
title: Sentiment analysis of football fan tweets during a game
author: Tim Raiswell
date: '2018-05-18'
tags:
  - football
  - mufc
  - R
  - text mining
slug: sentiment-analysis-of-football-fans
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
load("~/Blog/raiswell/mufc.RData")
```

```{r, eval = FALSE, echo = FALSE}
atheme <- theme_bw() + theme(text=element_text(family="Menlo"), plot.subtitle=element_text(face="bold")) + theme(panel.border = element_blank(), panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "gray"), axis.ticks.x=element_blank(), axis.ticks.y=element_blank(), axis.title.y = element_text(angle=0, size=10, vjust=1.0), strip.text.x = element_blank())
```


##Are Manchester United fans more critical of their team than opposing fans about theirs?

This was the (ambitious) question I intended to answer when I began this project, but having discovered some of the difficulties in accessing bulk, multi-period Twitter data I have been forced to scale it back. But that's the nature of analytics. I certainly intend to revist the bigger question using Twitter scraping solutions that have since become available but for now I'll restrict myself to the more achievable:

##Is there observable evidence in tweets from football fans during matches that one fanbase is more critical than another?

I was born and grew up in Manchester, England, but now I live in the States and I'm forced to follow the English Premiership remotely. I like to track my Twitter feed during games to see the opinion of other fans. One thing I noticed was the propensity of Manchester United fans to expect heroics from the team on a weekly basis and I wondered whether it was any different for fans of other clubs.

First, I load the packages I'll use in R. Tidyverse and tidytext will help me format the data and prepare my analysis. The twitteR and ROauth packages are what I will use to create my sentiment data for the football teams in question. 

Full documentation for how to use both those Twitter-related packages can be found [here in the user vignette](http://geoffjentry.hexdump.org/twitteR.pdf).
```{r}
pacman::p_load(tidyverse, twitteR, ROAuth, tidytext, psych,lubridate, SentimentAnalysis, scales, RCurl, tm, grid, wrapr)
```

Next, I setup my Twitter authentification information so I can start acessing the relevant API. You will need a Twitter account to do this. Full details are included the vignette linked above.

```{r, message = FALSE, warning = FALSE, eval = FALSE}
# Declare Twitter API Credentials
api_key <- "TEt0KZ4RddAOre4GsbOdbupOT" # From dev.twitter.com
api_secret <- "nUt2O4PUSDdAl6cZ2GvWW9mzrUL5J3g1eeiolhHo52sSFPXBbe" # From dev.twitter.com
token <- "742737889809838080-CtQrGFnDUF2c4VrpnFLQssmVuwhO3fP" # From dev.twitter.com
token_secret <- "RxryAiaY1DuxSdQ6873b6TiuX48fZvgtIAj2mPdKTixG4" # From dev.twitter.com
 
# Create Twitter Connection
setup_twitter_oauth(api_key, api_secret, token, token_secret)
```

<h2>Data Acquisition</h2>
I want to keep this simple to begin with. The paper I reference above demonstrates various data mining and analytic approaches we could pursue for the best answer to my question, but I want to begin with analysis of a few football matches to see what can be done. Let's start by pulling down a set of relevant tweets from the Twitter API for Manchester United's game against Yeovil Town in the FA Cup played on January 26, 2018.

```{r, eval = FALSE}
mufc_tweets1 <- searchTwitteR("manchesterunited", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>% 
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.
mufc_tweets2 <- searchTwitteR("#mufc", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>% 
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.
mufc_tweets3 <- searchTwitteR("#manu", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>% 
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.

mufc_tweets <- merge.list(mufc_tweets1, mufc_tweets2, mufc_tweets3) # I merge the three Twitter lists into a single list before conversion into a dataframe using the merge.list function from the RCurl package.

```

Now I can convert the output to a dataframe.
```{r, eval = FALSE}
#convert output to a data frame
mufc_tweets_df <- twListToDF(mufc_tweets)
dim(mufc_tweets_df) # examine dimensions
```
Now we examine the column names to get a better sense of the variables in the data. The data is fairly intuitive. We are most interested in the 'text' variable as this contains the subject matter for our sentiment analysis. 
```{r}
names(mufc_tweets_df) # lists variable names
```

I clean the text field so that it's readable by R and by the human eye too. When I first wrote this code I did not implement it as a function; when I realized I would need to reuse the approach multiple times I wrap it to make it faster for future use. 


```{r, eval = FALSE}

cleantweet <- function(x) {
  data("stop_words") # stop words dict as a data frame from the tidytext package.
  stopwords <- as.vector(stop_words$word)
  x$text <- removeWords(x$text, stopwords)
  replace_reg <-
  "https://t.co/[A-Za-z\\d]+|http://[A-Za-z\\d]+|&amp;|&lt;|&gt;|RT|https|#039;|\n|[^\x01-\x7F]|�|  "
  x <-
  x %>%  # regular expressions (regex) useful for cleaning twitter data
  mutate(text = str_replace_all(text, replace_reg, "")) %>%
  filter(
  !str_detect(text, "LIVE") | # Regex specific to sports tweets that are riddled with gambling advertisements
  !str_detect(text, "Betfair") |
  !str_detect(text, "Stream") |
  !str_detect(text, "Betting") |
  !str_detect(text, "betting") |
  !str_detect(text, "stream")
  ) 
  return(x)
}

mufc_tweets_df <- cleantweet(mufc_tweets_df) # run the function on the Twitter dataframe

```

I convert the relevant text column to a text vector so it can be used by the tm package's removeWords function. I used this because I want to leave the tweets whole, and not disaggregate using unnest_tokens() in 'tidytext'. 

I run sentiment analysis on the cleaned text field, again using a function so that I can repeat this analysis quickly in the future.
```{r, eval = FALSE}
mufc_data <- mufc_tweets_df %>%
  select(text, favoriteCount, retweetCount, created, location) # Select the fields I will use for the sentiment analysis and for plotting the results 
  
  sentiment_tw <- function(x) {
  vec <- as.vector(x$text)
  sentiment <- analyzeSentiment(vec)
  sentiment$SentimentQDAP <- as.numeric(sentiment$SentimentQDAP)
  x <- cbind(x, sentiment$SentimentQDAP)
  x <- rename(x, sentiment = `sentiment$SentimentQDAP`)
  return(x)
  }
  
  mufc_data <- sentiment_tw(mufc_data)

```


```{r}
preko <- as.POSIXlt("2018-01-26 19:45:00")
postgame <- as.POSIXlt("2018-01-26 22:00:00")
int <- interval(preko, postgame)
mufc_game <- mufc_data[mufc_data$created %within% int,]
row.names(mufc_game) <-
1:nrow(mufc_game) # renumber the rows consecutively from 1 so that the goal times are easier to find later for the sentiment plot.
```


```{r}

grob1 <- grobTree(textGrob("Happy", x=0.5,  y=0.98, hjust=0,
  gp=gpar(col="black", fontsize = 12, fontfamily = "Menlo", fontface = "bold")))

grob2 <- grobTree(textGrob("Angry", x=0.5,  y=0.1, hjust=0,
  gp=gpar(col="black", fontsize = 12, fontfamily = "Menlo", fontface = "bold")))

grob3 <- grobTree(textGrob("Rashford, '41", x=0.4,  y=0.805, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob4 <- grobTree(textGrob("Herrera, '61", x=0.62,  y=0.82, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob5 <- grobTree(textGrob("Lingard, '89", x=0.806,  y=0.82, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob6 <- grobTree(textGrob("Lukaku, '90 + 3", x=0.838,  y =0.776, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grobk <- grobTree(textGrob("Kick Off", x=0.165,  y =0.8, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 10, fontfamily = "Menlo", fontface = "bold")))

grobf <- grobTree(textGrob("Fulltime", x=0.87,  y =0.8, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 10, fontfamily = "Menlo", fontface = "bold")))


ggplot(data = mufc_game, aes(x = as.POSIXct(created), y = sentiment)) +
  geom_bin2d() +
  labs(x = "\nTime", y = "Sentiment", title = "Manchester United Twitter fan sentiment", subtitle = "Yeovil Town F.C. versus Manchester United F.C.\nFA Cup Round 4, Jan 26 2018\n", fill = "Tweet\ncount") +
  scale_fill_gradient(low = "#DA020E", high = "black", space = "Lab",
  na.value = "grey50", guide = "colourbar") +
  atheme +
  annotation_custom(grob1) +
  annotation_custom(grob2) +
  annotation_custom(grob3) +
  annotation_custom(grob4) +
  annotation_custom(grob5) +
  annotation_custom(grob6) +
  annotation_custom(grobk) +
  annotation_custom(grobf) +
  geom_vline(xintercept = mufc_game$created[173], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[130], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[66], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[45], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[340], color = "#DA020E", size = 1.8, alpha = 0.5) +
  geom_vline(xintercept = mufc_game$created[44], color = "#DA020E", size = 1.8, alpha = 0.5)

```

```{r, eval = FALSE}
ytfc_tweets1 <- searchTwitteR("#ytfc", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>%
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.

ytfc_tweets2 <- searchTwitteR("#yeoviltown", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>% 
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.

ytfc_tweets3 <- searchTwitteR("#yeovil", n=2000, lang="en", since="2018-01-26", until = "2018-01-26") %>% 
  strip_retweets(strip_manual = TRUE, strip_mt = TRUE) # ...remove manual retweets that are labeled 'RT'.

ytfc_tweets <- merge.list(ytfc_tweets1, ytfc_tweets2, ytfc_tweets3) # I merge the three Twitter lists into a single list before conversion into a dataframe using the merge.list function from the RCurl package.
```


```{r}
#convert output to a data frame
ytfc_tweets_df <- twListToDF(ytfc_tweets)
dim(ytfc_tweets_df) # examine dimensions

```

```{r}
ytfc_tweets_df <- cleantweet(ytfc_tweets_df)
```

```{r}
ytfc_data <- ytfc_tweets_df %>% 
  select(text, favoriteCount, retweetCount, created, location) %>% 
  sentiment_tw()
```

```{r}
ytfc_game <- ytfc_data[ytfc_data$created %within% int, ]
```

```{r}

grob7 <- grobTree(textGrob("Rashford, '41", x=0.36,  y=0.805, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob8 <- grobTree(textGrob("Herrera, '61", x=0.605,  y=0.82, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob9 <- grobTree(textGrob("Lingard, '89", x=0.814,  y=0.82, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob10 <- grobTree(textGrob("Lukaku, '90 + 3", x=0.846,  y =0.785, just = "right", rot = 270,
  gp=gpar(col="#DA020E", fontsize = 8, fontfamily = "Menlo", fontface = "bold")))

grob11 <- grobTree(textGrob("Fulltime", x=0.87,  y =0.8, just = "right", rot = 270,
  gp=gpar(col="#377D22", fontsize = 10, fontfamily = "Menlo", fontface = "bold")))

grob12 <- grobTree(textGrob("Kick Off", x=0.084,  y =0.8, just = "right", rot = 270,
  gp=gpar(col="#377D22", fontsize = 10, fontfamily = "Menlo", fontface = "bold")))


ggplot(data = ytfc_game, aes(x = as.POSIXct(created), y = sentiment)) +
  geom_bin2d() +
  labs(x = "\nTime", y = "Sentiment", title = "Yeovil Town Twitter fan sentiment", subtitle = "Yeovil Town F.C. versus Manchester United F.C.\nFA Cup Round 4, Jan 26 2018\n", fill = "Tweet\ncount") +
  scale_fill_gradient(low = "#377D22", high = "black", space = "Lab",
  na.value = "grey50", guide = "colourbar") +
  atheme +
  annotation_custom(grob1) +
  annotation_custom(grob2) +
  annotation_custom(grob7) +
  annotation_custom(grob8) +
  annotation_custom(grob9) +
  annotation_custom(grob10) +
  annotation_custom(grob11) +
  annotation_custom(grob12) +
  geom_vline(xintercept = mufc_game$created[173], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[130], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[66], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[45], color = "#DA020E") +
  geom_vline(xintercept = mufc_game$created[340], color = "#377D22", size = 1.8, alpha = 0.5) +
  geom_vline(xintercept = mufc_game$created[44], color = "#377D22", size = 1.8, alpha = 0.5)



```

```{r}
mean(mufc_game$sentiment)
mean(ytfc_game$sentiment)
```



<h3>Improvement focus areas:</h3>
1. Build
2. 


Here are the texts I relied on most while writing these notes:
<h3>Key References</h3>
<ul>
<li>Said JAI-ANDALOUSSI, Imane EL MOURABIT, Nabil MADRANE, Samia BENABDELLAH CHAOUNI, Abderrahim SEKKAKI, ['Soccer Events Summarization by Using Sentiment Analysis'](http://ieeexplore.ieee.org/abstract/document/7424124/z), Computational Science and Computational Intelligence (CSCI), 2015, pps 398	- 403.
<li>Silge J and Robinson D (2016). “tidytext: Text Mining and Analysis Using Tidy Data Principles in R.” JOSS, 1(3). [doi: 10.21105/joss.00037](http://dx.doi.org/10.21105/joss.00037).  
[Free online Bookdown version](https://www.tidytextmining.com).
<li>
</ul>

```{r}


```

